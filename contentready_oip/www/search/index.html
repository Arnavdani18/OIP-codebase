<!-- jinja -->
<!-- no-breadcrumbs -->
<!-- static -->
<div class="container">
    <div class="input-group">
        <input type="text" class="form-control form-control-lg" aria-label="Search the Open Innovation Platform" id="search-input">
        <div class="input-group-append">
          <button type="button" data-enabled=1 class="btn btn-primary" onclick="toggleProblems()" id="problem-selector">Problems</button>
          <button type="button" data-enabled=1 class="btn btn-primary" onclick="toggleSolutions()" id="solution-selector">Solutions</button>
        </div>
      </div>
</div>

<div class="container card-section hidden" id="search-results-container">
    <div class="row">
        <div class="col-lg-6" id="problem-results-container">
            <div class="col p-0">
                <div class="problem-listed-title text-white">
                    <div class="d-flex align-items-center header">
                        <img
                            src="/files/problem_icon.svg"
                            alt=""
                            height="20px"
                            width="24px"
                        />
                        <h2 class="heading">Problems Listed</h2>
                        <div class="view-all">
                            <a href="/problems">
                                View All
                            </a>
                        </div>
                    </div>
                </div>
                <div id="matching-problems"></div>
                </div>
            </div>
            <div class="col-lg-6 margin-sm-md-30" id="solution-results-container">
                <div class="col p-0">
                    <div class="problem-listed-title text-white">
                        <div class="d-flex align-items-center header">
                            <img
                                src="/files/problem_icon.svg"
                                alt=""
                                height="20px"
                                width="24px"
                            />
                            <h2 class="heading">Solutions Listed</h2>
                            <div class="view-all">
                                <a href="/solutions">
                                    View All
                                </a>
                            </div>
                        </div>
                    </div>
                    <div id="matching-solutions"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    frappe.ready(async () => {
        // Simple sleep(ms) function from https://stackoverflow.com/a/48882182
        const sleep = m => new Promise(r => setTimeout(r, m));

        toggleProblems = () => {
            const problemsEnabled = $('#problem-selector').data('enabled');
            if (problemsEnabled) {
                $('#problem-selector').data('enabled', 0);
                $('#problem-selector').removeClass('btn-primary').addClass('btn-light');
                $('#problem-results-container').hide();
                // $('#solution-results-container').removeClass('col-lg-6').addClass('col-lg-12');
            } else {
                $('#problem-selector').data('enabled', 1);
                $('#problem-selector').removeClass('btn-light').addClass('btn-primary');
                $('#problem-results-container').show();
                // $('#solution-results-container').removeClass('col-lg-12').addClass('col-lg-6');
                triggerSearch();
            }
        }

        toggleSolutions = () => {
            const solutionsEnabled = $('#solution-selector').data('enabled');
            if (solutionsEnabled) {
                $('#solution-selector').data('enabled', 0);
                $('#solution-selector').removeClass('btn-primary').addClass('btn-light');
                $('#solution-results-container').hide();
            } else {
                $('#solution-selector').data('enabled', 1);
                $('#solution-selector').removeClass('btn-light').addClass('btn-primary');
                $('#solution-results-container').show();
                triggerSearch();
            }
        }

        lookForMatchingProblems = async (text) => {
            if (!text.length > 0) {
                return false;
            }
            frappe.call({
                method: 'contentready_oip.api.search_content_by_text',
                args: {
                    doctype: 'Problem',
                    text: text,
                },
                callback: function(r) {
                    // Add matching problems to div
                    $('#matching-problems').empty();
                    if (r.message.length > 0) {
                        r.message.map(el => {
                            $('#matching-problems').append(el);
                        });
                    } else {
                        $('#matching-problems').append('<br/><h4>No results found.</h4>');
                    }
                }
            });
        }

        lookForMatchingSolutions = async (text) => {
            if (!text.length > 0) {
                return false;
            }
            frappe.call({
                method: 'contentready_oip.api.search_content_by_text',
                args: {
                    doctype: 'Solution',
                    text: text,
                },
                callback: function(r) {
                    // Add matching problems to div
                    $('#matching-solutions').empty();
                    if (r.message.length > 0) {
                        r.message.map(el => {
                            $('#matching-solutions').append(el);
                        });
                    } else {
                        $('#matching-solutions').append('<br/><h4>No results found.</h4>');
                    }
                }
            });
        }

        triggerSearch = async (clicked) => {
            // Delay as the user is probably still typing. Only triggered on autosearch.
            if (!clicked) await sleep(500);
            // Look up text again - user could have typed something since the event was triggered.
            const key = $('#search-input').val().trim();
            const problemsEnabled = $('#problem-selector').data('enabled');
            const solutionsEnabled = $('#solution-selector').data('enabled');
            // console.log(problemsEnabled, solutionsEnabled);
            if (problemsEnabled) {
                $('#solutions-results-container').show();
                lookForMatchingProblems(key);
            } else {
                $('#problem-results-container').hide();
            }
            if (solutionsEnabled) {
                $('#solutions-results-container').show();
                lookForMatchingSolutions(key);
            } else {
                $('#solutions-results-container').hide()
            }
            $('#search-results-container').removeClass('hidden');
        }

        // Delay until page is fully rendered
        await sleep(200);

        // Look for similar problems and solutions when text is entered
        $('#search-input').val('');
        $('#search-input').on('keyup', (e) => {
            const key = e.target.value.trim();
            if (key.length && key.length % 3 === 0) {
                const problemsEnabled = $('#problem-selector').data('enabled');
                const solutionsEnabled = $('#solution-selector').data('enabled');
                if (!problemsEnabled && !solutionsEnabled) {
                    frappe.throw('Please enable at least one of Problems or Solutions to complete the search.')
                }
                triggerSearch();
            }
        });
    })
</script>

<style>
    .hidden{
        display: none;
    }
</style>