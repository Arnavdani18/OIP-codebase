<div class="shadow editor-container">
  <div class="row">
    <div class="col-auto comment-user pr-2">
      {% set doc_owner = frappe.session.user %} {% include
      "templates/includes/common/user_thumbnail.html" %}
    </div>
    <div class="input-group col pl-0">
      <!-- TODO: onblur="contractCommentArea(event.target.id)" -->

      <textarea
        class="form-control pattern1"
        style="padding-top: .8rem;"
        id="comment-area-{{doctype}}-{{name}}"
        placeholder="Add a comment..."
        rows="1"
        onfocus="expandCommentArea('{{doctype}}','{{name}}')"
      ></textarea>
      <div class="input-group-append">
        <button
          class="btn btn-outline-danger pattern1"
          title="Clear"
          type="button"
          onclick="cancelComment(`{{doctype}}`,`{{name}}`, `{{parent_div|default('', true)}}`)"
        >
          <i class="far fa-backspace fa-horizontal"></i>
        </button>
        <button
          class="btn btn-outline-primary pattern1"
          title="Attachment"
          type="button"
          onclick="showDropzone('{{doctype}}', '{{name}}')"
        >
          <i class="far fa-paperclip"></i>
        </button>
      </div>
    </div>
  </div>
  <div class="row mt-3 comment-btn-row" hidden>
    <div class="col ">
      <button
        class="btn primary-btn"
        type="button"
        onclick="submitComment('{{doctype}}', '{{name}}')"
      >
        Comment
      </button>
    </div>
  </div>
  <form
    class="dropzone dz-clickable hidden mt-3 pattern1"
    data-file-urls="[]"
    id="comment-dropzone-{{doctype}}-{{name}}"
  >
    <div class="dz-default dz-message">
      <button class="dz-button" type="button">
        Drop files here to upload
      </button>
    </div>
  </form>
</div>
<script>
  expandCommentArea = (doctype, name) => {
    // set rows=5
    $(`#comment-area-${doctype}-${name}`).attr('rows', '3');
    $('.comment-btn-row').attr('hidden', false);
  };

  contractCommentArea = (doctype, name) => {
    // set rows=1
    $(`#comment-area-${doctype}-${name}`).attr('rows', '1');
  };

  cancelComment = (doctype, name, parent_div) => {
    $(`#comment-dropzone-${doctype}-${name}`).addClass('hidden');
    $(`#comment-area-${doctype}-${name}`).val('');
    $('.comment-btn-row').attr('hidden', true);
    contractCommentArea(doctype, name);
    if (parent_div) {
      $(parent_div).addClass('hidden');
    }
  };

  submitComment = (doctype, name) => {
    const id = `comment-area-${doctype}-${name}`; // for compatibility with cancelComment
    const text = $(`#${id}`).val();
    const media = $(`#comment-dropzone-${doctype}-${name}`).data('file-urls');
    if (text.length) {
      // console.log(comment);
      frappe.call({
        method: 'contentready_oip.api.add_comment',
        args: { doctype: doctype, name: name, text: text, media: media },
        callback: r => {
          // console.log(r);
          if (doctype == 'Discussion') {
            cancelComment(doctype, name);
            window.location.reload();
          } else if (r.message) {
            if ($('#comments-list').length) {
              $('#comments-list').prepend(r.message);
              cancelComment(doctype, name);
            } else {
              cancelComment(doctype, name);
              window.location.reload();
            }
          }
        }
      });
    } else {
      frappe.throw('Cannot submit an empty comment.');
    }
  };

  showDropzone = (doctype, name) => {
    // set rows=5
    $(`#comment-dropzone-${doctype}-${name}`).removeClass('hidden');
  };

  frappe.ready(() => {
    // Start dropzone.js integration
    // const scriptPath = "public/js/dropzone.js";
    const dScriptUrl = '/files/dropzone.js';
    $.getScript(dScriptUrl, () => {
      // disable autoDiscover as we are manually binding the dropzone to a form element
      Dropzone.autoDiscover = false;
      $('#comment-dropzone-{{doctype}}-{{name}}').dropzone({
        url: '/api/method/upload_file',
        autoDiscover: false,
        // maxFiles: 1,
        addRemoveLinks: true,
        acceptedFiles: 'image/*',
        headers: {
          Accept: 'application/json',
          'X-Frappe-CSRF-Token': frappe.csrf_token
        },
        init: function() {
          // use this event to add to child table
          this.on('complete', file => {
            // console.log('{{name}}');
            const response = JSON.parse(file.xhr.response);
            const file_url = response.message.file_url;
            const media = $('#comment-dropzone-{{doctype}}-{{name}}').data(
              'file-urls'
            );
            media.push(file_url);
            $('#comment-dropzone-{{doctype}}-{{name}}').data(
              'file-urls',
              JSON.stringify(media)
            );
          });
          // use this event to remove from child table
          this.on('removedfile', file => {
            // console.log('removed', file);
            let media = $('#comment-dropzone-{{doctype}}-{{name}}').data(
              'file-urls'
            );
            media = media.filter(i => !i.endsWith(file.name));
            $('#comment-dropzone-{{doctype}}-{{name}}').data(
              'file-urls',
              JSON.stringify(media)
            );
          });
        }
      });
    });
    // End dropzone.js integration
  });
</script>

<script>
  frappe.ready(() => {
    $('.comment-user img').css({
      height: 40,
      width: 40,
      'border-radius': '50%'
    });
    $('.created-by-section').attr('hidden', true);
  });
</script>

<style>
  .hidden {
    display: none;
  }

  .editor-container {
    border: 1px solid var(--secondary1);
    border-radius: var(--round4);
    min-height: 6.6rem;
    padding: 1.3rem 2.1rem;
  }

  .commentSection {
    border-radius: 0.4rem;
    font-size: 1.4rem;
    line-height: 2.2rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }
</style>
