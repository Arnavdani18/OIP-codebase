<div class="likes">
  <button data-has-user-liked="0" id="like-icon-{{doctype}}-{{name}}" onclick="toggle_like('{{doctype}}','{{name}}' )"
    role="button" class="btn social-icon-btn">
    <i class="far fa-thumbs-up"></i>
  </button>
  <span class="social-stats" data-num-likes="{{likes | length}}" id="like-count-{{doctype}}-{{name}}">
    {{likes | length}}
  </span>
</div>

<script>
  changeUI = (btnId, countId, hasUserLiked, numLikes) => {
    $(btnId).data('has-user-liked', hasUserLiked);

    hasUserLiked
      ? $(btnId)
        .addClass('selected')
      : $(btnId)
        .removeClass('selected');
    $(countId).text(numLikes);
    $(countId).data('num-likes', numLikes);
  };

  toggle_like = (doctype, name) => {
    if (frappe.session.user === 'Guest') {
      frappe.throw('Please login to participate.');
    }
    frappe.call({
      method: 'contentready_oip.api.can_user_contribute',
      args: {
        child_doctype: 'Like Table',
        parent_doctype: doctype,
        parent_name: name
      },
      callback: r => {
        const has_contributed = r.message[0];
        const is_owner = r.message[1];
        if (is_owner) {
          frappe.throw(`You cannot like your own ${doctype}`);
        } else {
          const btnId = `#like-icon-${doctype}-${name}`;
          const countId = `#like-count-${doctype}-${name}`;
          // initial values
          let hasUserLiked = $(btnId).data('has-user-liked');
          let numLikes = $(countId).data('num-likes');
          if (hasUserLiked) {
            numLikes -= numLikes;
          } else {
            numLikes += numLikes;
          }
          hasUserLiked = !hasUserLiked;
          // TODO: Fix incorrect counts issue when making UI change before sending to server.
          // change UI first, then send to server -
          // changeUI(btnId, countId, hasUserLiked, numLikes);
          frappe.call({
            method: 'contentready_oip.api.toggle_contribution',
            args: {
              child_doctype: 'Like Table',
              parent_doctype: doctype,
              parent_name: name,
              field_name: 'likes'
            },
            callback: r => {
              // console.log(r);
              // server is the source of truth so we change the UI to reflect that.
              hasUserLiked = r.message[0];
              numLikes = r.message[1].length;
              changeUI(btnId, countId, hasUserLiked, numLikes);
            }
          });
        }
      }
    });
  };


  // TODO: Replace this call with a filter on the data-likes attribute.
  // However, currently, frappe does not expand child tables within child tables into dicts.
  frappe.ready(() => {
    frappe.call({
      method: 'contentready_oip.api.has_user_contributed',
      args: {
        child_doctype: 'Like Table',
        parent_doctype: '{{doctype}}',
        parent_name: '{{name}}'
      },
      callback: r => {
        const btnId = `#like-icon-{{doctype}}-{{name}}`;

        changeUI(btnId, null, r.message, null);
      }
    });
  });
</script>